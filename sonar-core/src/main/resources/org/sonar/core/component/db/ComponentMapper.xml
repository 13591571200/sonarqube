<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.sonar.core.component.db.ComponentMapper">

  <sql id="componentColumns">
    p.id,
    p.kee as kee,
    p.name as name,
    p.long_name as longName,
    p.qualifier as qualifier,
    p.scope as scope,
    p.language as language,
    s.root_project_id as projectId,
    p.root_id as subProjectId,
    p.path as path
  </sql>

  <select id="selectByKey" parameterType="String" resultType="Component">
    SELECT <include refid="componentColumns"/>
    FROM projects p
    INNER JOIN snapshots s ON s.project_id=p.id AND s.islast=${_true}
    <where>
      AND p.enabled=${_true}
      AND p.kee=#{key}
    </where>
  </select>

  <select id="selectById" parameterType="long" resultType="Component">
    SELECT <include refid="componentColumns"/>
    FROM projects p
    INNER JOIN snapshots s ON s.project_id=p.id AND s.islast=${_true}
    <where>
      AND p.enabled=${_true}
      AND p.id=#{id}
    </where>
  </select>

  <select id="countById" parameterType="long" resultType="long">
    SELECT count(p.id)
    FROM projects p
    <where>
      AND p.enabled=${_true}
      AND p.id=#{id}
    </where>
  </select>

  <select id="findModulesByProject" parameterType="String" resultType="Component">
    SELECT <include refid="componentColumns"/>
    FROM projects p
    INNER JOIN projects root ON root.id=p.root_id AND root.enabled=${_true} AND root.kee=#{projectKey}
    INNER JOIN snapshots s ON s.project_id=p.id AND s.islast=${_true}
    <where>
      AND p.enabled=${_true}
      AND p.scope='PRJ'
    </where>
  </select>

  <sql id="insertColumns">
    (kee, name, long_name, qualifier, scope, language, root_id, path, created_at)
  </sql>

  <insert id="insert" parameterType="Component" keyColumn="id" useGeneratedKeys="true" keyProperty="id">
    insert into projects <include refid="insertColumns"/>
    values (#{kee}, #{name}, #{longName}, #{qualifier}, #{scope}, #{language}, #{subProjectId}, #{path}, #{createdAt})
  </insert>

</mapper>

