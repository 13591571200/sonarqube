<h1 class="marginbottom10"><%= link_to 'Quality profiles', :controller => 'profiles', :action => 'index' -%> / <%= h @profile.language -%> / <%= h @profile.name %></h1>
<%= render :partial => 'profiles/tabs', :locals => {:selected_tab=>'changelog'} %>

<div class="tabs-panel marginbottom10">
  <% if @versions.empty? %>
    No changes has been done on this quality profile.
  <% else %>

  <% if !@past_versions.empty? %>
    <% form_tag({:action => 'changelog'}, {:method => 'post'}) do %>
      <%= hidden_field_tag "id", @profile.id %>
      Changelog between last version (<%= @versions[0].change_date.strftime("%Y/%m/%d %H:%M:%S") %>) and
      <%= select_tag "since", options_for_select(@past_versions.map {|u| ["version " + u.profile_version.to_s + " (" + u.change_date.strftime("%Y/%m/%d %H:%M:%S") + ")", u.profile_version]}, @since_version) %>
      <%= submit_tag "Load", :id => 'submit_since'%>
    <% end %>
  <% end %>

  <table  class="data width100">
    <thead>
      <tr>
        <th>Date</th>
        <th>User</th>
        <th>Action</th>
        <th>Rule</th>
        <th>Parameters</th>
      </tr>
    </thead>
    <% current_version = -1
      @changes.each do |change|
    %>
        <% if current_version != change.profile_version %>
    <tr>
      <td align="left" colspan="5">
        <div class="line-block">
          <h2>Version <%=change.profile_version%></h2>
        </div>
      </td>
    </tr>
        <%   current_version = change.profile_version
           end
        %>
    <tr class="<%= cycle 'even', 'odd', :name => change.profile_version -%>">
      <td valign="top"><%=change.change_date.strftime("%Y-%m-%d %H:%M:%S")%></td>
      <td valign="top"><%=change.user_login%></td>
      <td valign="top"><%=change.action_text%></td>
      <td valign="top"><%=change.rule.name%></td>
      <td valign="top">
        <% if change.old_severity
             if change.new_severity %>
            Severity changed from <%= image_tag "priority/#{change.old_severity_text}.png" %><b><%= change.old_severity_text %></b> to
          <% else %>
            Severity was <%= image_tag "priority/#{change.old_severity_text}.png" %><b><%= change.old_severity_text %></b>
          <% end
           end %>
        <% if change.new_severity
             if change.old_severity %>
           <%= image_tag "priority/#{change.new_severity_text}.png" %><b><%= change.new_severity_text %></b>
          <% else %>
           Severity set to <%= image_tag "priority/#{change.new_severity_text}.png" %><b><%= change.new_severity_text %></b>
          <% end
           end %>
        <% if (change.old_severity or change.new_severity) and change.parameters.size > 0 %>
          <br/>
        <% end %>
        <% change.parameters.each do |param_change| %>
          Parameter <b><%=param_change.name %></b>
          <% if not param_change.old_value %>
             set to <b><%= param_change.new_value %></b>
          <% elsif not param_change.new_value
               if change.enabled == false %>
                 was <b><%= param_change.old_value %></b>
            <% else %>
                 reset to default value (was <b><%= param_change.old_value %></b>)
            <% end
             else %>
             changed from <b><%= param_change.old_value %></b> to <b><%= param_change.new_value %></b>
          <% end %>
          <%= "<br/>" unless param_change == change.parameters.last %>
        <% end%>
      </td>
    </tr>
    <% end %>
  </table>

  <% end %>
</div>
