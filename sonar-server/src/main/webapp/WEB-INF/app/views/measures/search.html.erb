<% content_for :style do %>
  <style type="text/css">
    #search-form [type="text"].large-input {
      width: 180px;
    }

    #search-form select.large-input {
      width: 100%;
      box-sizing: border-box;
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
    }

    #search-form select option {
      padding: 1px 10px 1px 4px;
    }
  </style>
<% end %>
<%
   hidden_condition_indexes = []
   for i in 1..3 do
     unless @filter.criteria("c#{i}_metric") && @filter.criteria("c#{i}_val")
       hidden_condition_indexes << i
     end
   end
%>
<% content_for :script do %>
  <script>
    function submitSearch() {
      // remove empty parameters from URL
      var form = $j("#search-form");
      form.find(':input[value=""]').attr('name', '');
      form.submit();
      return false;
    }
    function removeUrlAttr(url, attribute_key) {
      var regexp = new RegExp("&?" + attribute_key + "=([^&]$|[^&]*)", "g");
      return url.replace(regexp, '');
    }
    function reloadParameters(params) {
      var url = decodeURI(window.location.href);
      $j.each(params, function (key, value) {
        url = removeUrlAttr(url, key);
        url += '&' + key + '=' + value;
      });
      window.location = url;
    }
    var hiddenConditionIndexes = [<%= hidden_condition_indexes.join(',') -%>];
    $j(document).ready(function () {
      $j('#select-lang').select2({allowClear:true, width:'100%', placeholder:'Languages'});
      $j('#select-qualifiers').select2({allowClear:true, width:'100%', placeholder:'Resources'});
      $j('#more-criteria')
        .select2({allowClear:true, width:'100%', placeholder:'+ More Criteria'})
        .on("change", function (e) {
          $j("#criteria-" + e.val).insertBefore($j("#more-td")).show();
          if (e.val == 'lang') {
            $j("#select-" + e.val).select2("enable");
            $j("#select-" + e.val).select2("focus");
          } else if (e.val == 'metric') {
            if (hiddenConditionIndexes.length > 0) {
              var index = hiddenConditionIndexes.pop();
              $j("#criteria-metric-" + index).insertBefore($j("#more-td")).show();
              $j("#c" + index + "_metric").select2("focus");
              if (hiddenConditionIndexes.length == 0) {
                $j("#more-criteria option[value='metric']").remove();
              }
            }
          } else {
            $j("#more-criteria option[value='" + e.val + "']").remove();
          }
          $j("#more-criteria").select2("val", "");
        });
    });
  </script>
<% end %>
<div>
  <div class="page-split-left">
    <% if logged_in? %>
      <ul id="filters">
        <% current_user.favourited_measure_filters.each do |filter| %>
          <li>
            <a href="<%= ApplicationController.root_context -%>/measures/filter/<%= filter.id -%>"><%= h filter.name -%></a>
          </li>
        <% end %>
      </ul>
      <a href="<%= ApplicationController.root_context -%>/measures/manage" class="link-action"><%= message('manage') %></a>
      <hr>
    <% end %>

    <form id="search-form" method="GET" action="<%= ApplicationController.root_context -%>/measures/search">
      <% if @filter.id %>
        <input type="hidden" name="id" value="<%= @filter.id -%>">
      <% end %>
      <%
         if @filter.display
           @filter.display.url_params.each do |k_v_array|
             if k_v_array[1].is_a?(String)
      %>
            <%= hidden_field_tag k_v_array[0], k_v_array[1] -%>
          <% else
               k_v_array[1].each do |string_val|
          %>
              <%= hidden_field_tag "#{k_v_array[0]}[]", string_val -%>
            <% end
               end
               end
               end
            %>
      <table class="spaced width100">
        <tbody>
        <tr>
          <td>
            <%= resource_select_tag 'baseId', :resource_type_property => 'supportsGlobalDashboards', :width => '100%', :selected_resource => @filter.base_resource, :placeholder => 'Path' -%>
          </td>
        </tr>
        <tr>
          <td>
            <%
               qualifiers = Api::Utils.java_facade.getResourceTypesForFilter().map do |resource_type|
                 [message("qualifiers.#{resource_type.getQualifier()}"), resource_type.getQualifier()]
               end
            %>
            <%= select_tag 'qualifiers[]', options_for_select(qualifiers, @filter.criteria['qualifiers']||''), :multiple => true, :id => 'select-qualifiers' -%>
          </td>
        </tr>
        <tr id="criteria-lang" <%= "style='display:none'" unless @filter.criteria('languages') -%>>
          <td>
            <% languages = [['', '']].concat(Api::Utils.languages.map { |lang| [lang.name, lang.key] }) %>
            <%= select_tag 'languages[]', options_for_select(languages, @filter.criteria['languages']), :multiple => true, :id => 'select-lang', 'data-placeholder' => 'Languages' -%>
          </td>
        </tr>
        <tr id="criteria-name" <%= "style='display:none'" unless @filter.criteria('nameSearch') -%>>
          <td>
            <%= message('measure_filter.name_contains') -%>:<br>
            <input type="text" name="nameSearch" value="<%= h @filter.criteria['nameSearch'] -%>"></td>
        </tr>
        <tr id="criteria-key" <%= "style='display:none'" unless @filter.criteria('keyRegexp') -%>>
          <td>
            <%= message('measure_filter.key_like') -%>:<br>
            <input type="text" name="keyRegexp" value="<%= h @filter.criteria['keyRegexp'] -%>" class="large-input"></td>
        </tr>
        <tr id="criteria-fav" <%= "style='display:none'" unless @filter.criteria('onFavourites') -%>>
          <td>
            <%= message 'measure_filter.only_favourites' %>:<br>
            <%= check_box_tag 'onFavourites', 'true', @filter.criteria['onFavourites']=='true' -%>
          </td>
        </tr>

        <% condition_metrics = Metric.all.select { |m| m.numeric? } %>
        <% for i in 1..3 %>
          <tr id="criteria-metric-<%= i -%>" <%= "style='display: none'" if hidden_condition_indexes.include?(i) -%>>
            <td style="padding:10px 5px">
              <%= metric_select_tag "c#{i}_metric", condition_metrics, :allow_empty => true, :selected_key => @filter.criteria("c#{i}_metric"), :width => '100%', :placeholder => 'Metric' -%>
              <%= select_tag "c#{i}_period", options_for_select([['Value', ''], ['Period 1', '1'], ['Period 2', '2'], ['Period 3', '3']], @filter.criteria("c#{i}_period")) -%>
              <br>
              <%= select_tag "c#{i}_op", options_for_select([['=', 'eq'], ['<', 'lt'], ['<=', 'lte'], ['>', 'gt'], ['>=', 'gte']], @filter.criteria("c#{i}_op")) -%>
              <input type="text" size="5" name="c<%= i -%>_val" value="<%= h @filter.criteria("c#{i}_val") -%>">
            </td>
          </tr>
        <% end %>
        <tr id="criteria-date" <%= "style='display:none'" unless @filter.criteria('fromDate') || @filter.criteria('toDate') -%>>
          <td>
            From date:
            <input type="text" name="fromDate" value="<%= @filter.criteria['fromDate'] -%>" size="10" maxlength="10">
            <br>
            To date:
            <input type="text" name="toDate" value="<%= @filter.criteria['toDate'] -%>" size="10" maxlength="10"><br>
            <span class="note">year-month-day (2012-01-31)</span>
          </td>
        </tr>
        <tr id="criteria-age" <%= "style='display:none'" unless @filter.criteria('ageMinDays') || @filter.criteria('ageMaxDays') -%>>
          <td>
            More than
            <input type="text" name="ageMinDays" value="<%= @filter.criteria['ageMinDays'] -%>" size="3"> days ago
            <br>Within the last
            <input type="text" name="ageMaxDays" value="<%= @filter.criteria['ageMaxDays'] -%>" size="3"> days
          </td>
        </tr>
        <tr id="more-td">
          <td>
            <select id="more-criteria">
              <option value=""></option>
              <option value="age">Age</option>
              <option value="date">Date</option>
              <option value="fav">Favourites Only</option>
              <option value="key">Key</option>
              <option value="lang">Language</option>
              <option value="metric">Metric</option>
              <option value="name">Name</option>
            </select>
          </td>
        </tr>

        <tr>
          <td>
            <input type="button" name="search" value="<%= message('search_verb') -%>" onclick="submitSearch()">
          </td>
        </tr>
        <tr>
          <td>
            <a href="<%= ApplicationController.root_context -%>/measures" class="link-action">New search</a>
            <% if logged_in? %>
              <% if @filter.id==nil || @filter.user_id==current_user.id %>
                - <a id="save" href="<%= url_for params.merge({:action => 'save_form', :id => @filter.id}) -%>" class="link-action open-modal"><%= message('save') -%></a>
              <% end %>
              <% if @filter.id %>
                - <a id="copy" href="<%= url_for params.merge({:action => 'copy_form', :id => @filter.id}) -%>" class="link-action open-modal"><%= message('copy') -%></a>
              <% end %>
            <% end %>
          </td>
        </tr>
        </tbody>
      </table>
    </form>
  </div>

  <% if @filter.results && @filter.display %>
    <div class="page-split-right">
      <div id="content">

        <% if @filter.name %>
          <p>
            <span class="h3"><%= h @filter.name -%></span>
            <% if @filter.description.present? %>
              - <span><%= h @filter.description -%></span>
            <% end %>
          </p>
        <% end %>

        <%
           edit_mode = (params[:edit]=='true')
           unless edit_mode
        %>
          <table class="width100">
            <tr>
              <td class="left">
                Display as:
                <% MeasureFilterDisplay.keys.each do |display_key| %>
                  <%= link_to_if display_key!=@filter.display.key, display_key, params.merge(:action => 'search', :display => display_key, :id => @filter.id) -%>
                <% end %>
              <td class="right">
                <a id="edit" href="<%= url_for params.merge({:edit => true, :id => @filter.id}) -%>" class="button"><%= message('configure') -%></a>
              </td>
            </tr>
          </table>
        <% end %>
        <% if @filter.security_exclusions %>
          <p class="notes"><%= message('results_not_display_due_to_security') -%></p>
        <% end %>
        <%= render :partial => "measures/display_#{@filter.display.class::KEY}", :locals => {:edit_mode => edit_mode} -%>
      </div>
    </div>
  <% end %>
</div>