<% content_for :style do %>
  <style type="text/css">
    #filter-form {
      float: left;
      width: 240px;
    }

    #filter-form select {
      width: 200px;
      padding: 1px;
    }

    #filter-form select option {
      padding: 1px 10px 1px 4px;
    }

    #filter-result {
      padding-left: 250px;
    }
  </style>
<% end %>

<div id="measure-filter">
  <div id="filter-form">
    <form method="GET" action="<%= ApplicationController.root_context -%>/measures/search">
      <% if @filter.id %>
        <input type="hidden" name="id" value="<%= @filter.id -%>">
      <% end %>
      <table>
        <tbody>
        <tr>
          <td>
            Base:<br>
            <input type="text" name="base" value="<%= @filter.criteria['base'] -%>">
          </td>
        </tr>
        <tr>
          <td>
            On components:<br>
            <%= check_box_tag 'onBaseComponents', 'true', @filter.criteria['onBaseComponents'] -%>
          </td>
        </tr>
        <tr>
          <td>
            Qualifiers:<br>
            <%= select_tag 'qualifiers[]', options_for_select([['Any', ''], ['Project', 'TRK'], ['Sub-project', 'BRC'], ['Directory/Package', 'PAC'], ['File', 'CLA']], @filter.criteria['qualifiers']||''), :size => 5, :multiple => true -%>
          </td>
        </tr>
        <tr>
          <td>
            Language:<br>
            <% languages = [['Any', '']].concat(Api::Utils.languages.map { |lang| [lang.name, lang.key] }) %>
            <%= select_tag 'languages[]', options_for_select(languages, @filter.criteria['languages']||''), :size => 5, :multiple => true -%>
          </td>
        </tr>
        <tr>
          <td>
            Name:<br>
            <input type="text" name="nameRegexp"></td>
        </tr>
        <tr>
          <td>
            Key:<br>
            <input type="text" name="keyRegexp"></td>
        </tr>
        <tr>
          <td>
            Favourites only:<br>
            <%= check_box_tag 'onFavourites', 'true', params['onFavourites']=='true' %>
          </td>
        </tr>
        <tr>
          <td>
            From date:<br>
            <input type="text" name="fromDate" value="<%= params['fromDate'] -%>">
          </td>
        </tr>
        <tr>
          <td>
            To date:<br>
            <input type="text" name="toDate" value="<%= params['toDate'] -%>">
          </td>
        </tr>
        <tr>
          <td>
            Before:<br>
            <input type="text" name="beforeDays" value="<%= params['beforeDays'] -%>" size="4"> days
          </td>
        </tr>
        <tr>
          <td>After:<br>
            <input type="text" name="afterDays" value="<%= params['afterDays'] -%>" size="4"> days
          </td>
        </tr>
        <tr>
          <td>
            <input type="submit" name="search" value="Search">
            <a href="<%= ApplicationController.root_context -%>/measures">Reset</a>
          </td>
        </tr>
        </tbody>
      </table>
    </form>

    <br/>

    <% if logged_in? %>
      <ul id="my-filters">
        <% current_user.measure_filters.each do |my_filter| %>
          <li>
            <a href="<%= ApplicationController.root_context -%>/measures/filter/<%= my_filter.id -%>"><%= h my_filter.name -%></a>
          </li>
        <% end %>
      </ul>
    <% end %>
  </div>

  <% if @filter.results %>
    <div id="filter-result">
      <% if @filter.name %>
        <h2><%= h @filter.name -%></h2>
        <% if @filter.description %>
          <p><%= h @filter.description -%></p>
        <% end %>
      <% end %>

      Display as:
      <% MeasureFilter::DISPLAYS.each do |display_class| %>
        <%= link_to_if display_class::KEY!=@filter.display.class::KEY, display_class::KEY, params.merge(:action => 'search', :display => display_class::KEY, :id => nil) -%>
      <% end %>

      <% if logged_in? && (@filter.user_id==nil || @filter.user_id==current_user.id) %>
        <a id="save_as" href="<%= url_for params.merge({:action => 'save_form', :id => @filter.id}) -%>" class="link-action open-modal"><%= message('save') -%></a>
      <% end %>

      <%= render :partial => "measures/display_#{@filter.display.class::KEY}" -%>
      <br>

      <% if @filter.security_exclusions %>
        <p class="notes"><%= message('results_not_display_due_to_security') -%></p>
      <% end %>

    </div>
  <% end %>
  </p>

</div>