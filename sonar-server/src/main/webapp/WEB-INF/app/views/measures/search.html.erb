<% content_for :style do %>
  <style type="text/css">
    #search-form [type="text"].large-input {
      width: 180px;
    }

    #search-form select.large-input {
      width: 100%;
      box-sizing: border-box;
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
    }

    #search-form select option {
      padding: 1px 10px 1px 4px;
    }
  </style>
<% end %>
<% content_for :script do %>
  <script>
    function submitSearch() {
      // remove empty parameters from URL
      var form = $j("#search-form");
      form.find(':input[value=""]').attr('name', '');
      form.submit();
      return false;
    }
    function removeUrlAttr(url, attribute_key) {
      var regexp = new RegExp("&?" + attribute_key + "=([^&]$|[^&]*)", "g");
      return url.replace(regexp, '');
    }
    function reloadParameters(params) {
      var url = decodeURI(window.location.href);
      $j.each(params, function (key, value) {
        url = removeUrlAttr(url, key);
        url += '&' + key + '=' + value;
      });
      window.location = url;
    }
    var filtersLoaded = false;
    $j(document).ready(function () {
        $j('#search-pill').on('click', function (e) {
          $j('#search-pill').parent().addClass('active');
          $j('#filters-pill').parent().removeClass('active');
          $j('#search-form').show();
          $j('#filters').hide();
        });
        $j('#filters-pill').on('click', function (e) {
          $j('#search-pill').parent().removeClass('active');
          $j('#filters-pill').parent().addClass('active');
          $j('#search-form').hide();
          $j('#filters').show();
          if (!filtersLoaded) {
            $j('#filters').load(baseUrl + '/measures/filters');
            filtersLoaded = true;
          }
        });
      }
    );
  </script>
<% end %>
<div id="measure-filters">
  <div class="page-split-left">
    <ul class="nav-pills" id="nav-pills">
      <li class="active"><a href="#" id="search-pill">Search</a></li>
      <li><a href="#" id="filters-pill">Filters</a></li>
    </ul>
    <div id="filters" style="display:none"><%= image_tag 'loading.gif' -%></div>
    <form id="search-form" method="GET" action="<%= ApplicationController.root_context -%>/measures/search">
      <% if @filter.id %>
        <input type="hidden" name="id" value="<%= @filter.id -%>">
      <% end %>
      <%
         if @filter.display
           @filter.display.url_params.each do |k_v_array|
             if k_v_array[1].is_a?(String)
      %>
            <%= hidden_field_tag k_v_array[0], k_v_array[1] -%>
          <% else
               k_v_array[1].each do |string_val|
          %>
              <%= hidden_field_tag "#{k_v_array[0]}[]", string_val -%>
            <% end
               end
               end
               end
            %>
      <table class="width100">
        <tbody>
        <tr>
          <td class="width100">
            Base:<br>
            <%= resource_select_tag 'baseId', :resource_type_property => 'supportsGlobalDashboards', :width => '100%', :selected_resource => @filter.base_resource -%>
          </td>
        </tr>
        <tr>
          <td class="width100">
            On components:<br>
            <%= check_box_tag 'onBaseComponents', 'true', @filter.criteria['onBaseComponents'] -%>
          </td>
        </tr>
        <tr>
          <td class="width100">
            Qualifiers:<br>
            <%
               qualifiers = Api::Utils.java_facade.getResourceTypesForFilter().map do |resource_type|
                 [message("qualifiers.#{resource_type.getQualifier()}"), resource_type.getQualifier()]
               end
            %>
            <%= select_tag 'qualifiers[]', options_for_select([[message('any'), '']].concat(qualifiers), @filter.criteria['qualifiers']||''), :size => 5, :multiple => true, :class => 'large-input' -%>
          </td>
        </tr>
        <tr>
          <td>
            Language:<br>
            <% languages = [[message('any'), '']].concat(Api::Utils.languages.map { |lang| [lang.name, lang.key] }) %>
            <%= select_tag 'languages[]', options_for_select(languages, @filter.criteria['languages']||''), :size => 5, :multiple => true, :class => 'large-input' -%>
          </td>
        </tr>
        <tr>
          <td class="width100">
            <%= message('measure_filter.name_contains') -%>:<br>
            <input type="text" name="nameRegexp" value="<%= h @filter.criteria['nameRegexp'] -%>" class="large-input"></td>
        </tr>
        <tr>
          <td class="width100">
            <%= message('measure_filter.key_like') -%>:<br>
            <input type="text" name="keyRegexp" value="<%= h @filter.criteria['keyRegexp'] -%>" class="large-input"></td>
        </tr>
        <tr>
          <td>
            <%= message 'measure_filter.only_favourites' %>:<br>
            <%= check_box_tag 'onFavourites', 'true', @filter.criteria['onFavourites']=='true' -%>
          </td>
        </tr>

        <% condition_metrics = Metric.all.select { |m| m.numeric? } %>
        <tr>
          <td>
            <br>
            <%= metric_select_tag 'c1_metric', condition_metrics, :allow_empty => true, :selected_key => @filter.criteria('c1_metric'), :width => '180px' -%>
            <%= select_tag 'c1_period', options_for_select([['Value', ''], ['Period 1', '1'], ['Period 2', '2'], ['Period 3', '3']], @filter.criteria('c1_period')) -%>
            <%= select_tag 'c1_op', options_for_select([['Equals', 'eq'], ['Less than', 'lt'], ['Less or equals', 'lte'], ['Greater than', 'gt'], ['Greater or equals', 'gte']], @filter.criteria('c1_op')) -%>
            <input type="text" size="5" name="c1_val" value="<%= h @filter.criteria('c1_val') -%>">
            <br><br>
          </td>
        </tr>

        <tr>
          <td>
            <br>
            <%= metric_select_tag 'c2_metric', condition_metrics, :allow_empty => true, :selected_key => @filter.criteria('c2_metric'), :width => '180px' -%>
            <%= select_tag 'c2_period', options_for_select([['Value', ''], ['Period 1', '1'], ['Period 2', '2'], ['Period 3', '3']], @filter.criteria('c2_period')) -%>
            <%= select_tag 'c2_op', options_for_select([['Equals', 'eq'], ['Less than', 'lt'], ['Less or equals', 'lte'], ['Greater than', 'gt'], ['Greater or equals', 'gte']], @filter.criteria('c2_op')) -%>
            <input type="text" size="5" name="c2_val" value="<%= h @filter.criteria('c2_val') -%>">
            <br><br>
          </td>
        </tr>

        <tr>
          <td>
            From date:<br>
            <input type="text" name="fromDate" value="<%= @filter.criteria['fromDate'] -%>">
          </td>
        </tr>
        <tr>
          <td>
            To date:<br>
            <input type="text" name="toDate" value="<%= @filter.criteria['toDate'] -%>">
          </td>
        </tr>
        <tr>
          <td>
            More than:<br>
            <input type="text" name="beforeDays" value="<%= @filter.criteria['beforeDays'] -%>" size="4"> days ago
          </td>
        </tr>
        <tr>
          <td>Within the last:<br>
            <input type="text" name="afterDays" value="<%= @filter.criteria['afterDays'] -%>" size="4"> days
          </td>
        </tr>
        <tr>
          <td>
            <br/>
            <input type="button" name="search" value="Search" onclick="submitSearch()">
            <a href="<%= ApplicationController.root_context -%>/measures">New search</a>
          </td>
        </tr>
        </tbody>
      </table>
    </form>
  </div>

  <% if @filter.results && @filter.display %>
    <div id="filter-result" class="page-split-right">

      <% if @filter.name %>
        <p>
          <span class="h3"><%= h @filter.name -%></span>
          <% if @filter.description.present? %>
            - <span><%= h @filter.description -%></span>
          <% end %>
        </p>
      <% end %>

      <%
         edit_mode = (params[:edit]=='true')
         unless edit_mode
      %>
        <table class="width100">
          <tr>
            <td class="left">
              Display as:
              <% MeasureFilterDisplay.keys.each do |display_key| %>
                <%= link_to_if display_key!=@filter.display.key, display_key, params.merge(:action => 'search', :display => display_key, :id => @filter.id) -%>
              <% end %>
            <td class="right">
              <a id="edit" href="<%= url_for params.merge({:edit => true, :id => @filter.id}) -%>" class="button"><%= message('configure') -%></a>
              <% if logged_in? %>
                <% if @filter.id==nil || @filter.user_id==current_user.id %>
                  <a id="save" href="<%= url_for params.merge({:action => 'save_form', :id => @filter.id}) -%>" class="button open-modal"><%= message('save') -%></a>
                <% end %>
                <% if @filter.id %>
                  <a id="copy" href="<%= url_for params.merge({:action => 'copy_form', :id => @filter.id}) -%>" class="button open-modal"><%= message('copy') -%></a>
                <% end %>
              <% end %>
              </tr>
        </table>
      <% end %>
      <% if @filter.security_exclusions %>
        <p class="notes"><%= message('results_not_display_due_to_security') -%></p>
      <% end %>
      <%= render :partial => "measures/display_#{@filter.display.class::KEY}", :locals => {:edit_mode => edit_mode} -%>
    </div>
  <% end %>

</div>