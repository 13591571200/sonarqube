<% if edit_mode %>
  <table class="spaced width100 admin">
    <tr>
      <td valign="top" class="thin nowrap">
        <span class="comments"><%= message('size') -%></span>
        <br/>
        <%= metric_select_tag 'tmSize', Metric.all.select { |m| m.treemap_size? },
                              :html_id => 'select-tm-size',
                              :selected_key => @filter.display.size_metric.key -%>
      </td>
      <td valign="top" class="thin nowrap">
        <span class="comments"><%= message('color') -%></span>
        <span id="tm-gradient" class="note"></span>
        <br/>
        <%= metric_select_tag 'tmColor', Metric.all.select { |m| m.treemap_color? },
                              :html_id => 'select-tm-color',
                              :allow_empty => true,
                              :selected_key => (@filter.display.color_metric ? @filter.display.color_metric.key : nil) -%>

        <button id="update-treemap">Update</button>
      </td>
      <td class="right" valign="bottom">
        <a href="#" class="button" id="exit-edit">Done</a>
      </td>
    </tr>
  </table>
  <% content_for :script do %>
    <script>
      $j(document).ready(function () {
        $j("#update-treemap").on("click", function (e) {
          var url = removeUrlAttr(decodeURI(window.location.href), 'tmSize');
          url = removeUrlAttr(url, 'tmColor');
          url += '&tmSize=' + $j('#select-tm-size').val();
          var color = $j('#select-tm-color').val();
          if (color != null && color != '') {
            url += '&tmColor=' + color;
          }
          window.location = url;
        });
        $j("#exit-edit").on("click", function (e) {
          window.location = removeUrlAttr(decodeURI(window.location.href), 'edit');
        });
      });
    </script>
  <% end %>
<% end %>

<div class="treemap" style="width: 100%; height:<%= @filter.display.height %>px;">
  <%= @filter.display.html -%>
</div>