<%
   display_favourites = logged_in?
   colspan = @filter.display.columns.size
   colspan += 1 if display_favourites
   if edit_mode
     content_for :script do
%>
    <script>
      var cols = [<%= @filter.display.columns.map{|c| "'#{c.key}'"}.join(',')-%>];
      function leftCol(id) {
        var cell = $j('#measures-table tr.admin td[index=' + id + ']');
        var columnIndex = cell.parent().children().index(cell);
        if (columnIndex > 0) {
          moveCol(columnIndex - 1, columnIndex);
        }
      }
      function rightCol(id) {
        var cell = $j('#measures-table tr.admin td[index=' + id + ']');
        var columnIndex = cell.parent().children().index(cell);
        if (columnIndex < cols.length - 1) {
          moveCol(columnIndex, columnIndex + 1);
        }
      }
      function moveCol(from, to) {
        var temp = cols[from];
        cols[from] = cols[to];
        cols[to] = temp;
        $j('#measures-table thead tr').each(function () {
          var tr = $j(this);
          var td1 = tr.find('th:eq(' + from + ')');
          var td2 = tr.find('th:eq(' + to + ')');
          td1.detach().insertAfter(td2);
        });
        $j('#measures-table tbody tr').each(function () {
          var tr = $j(this);
          var td1 = tr.find('td:eq(' + from + ')');
          var td2 = tr.find('td:eq(' + to + ')');
          td1.detach().insertAfter(td2);
        });
      }
      function deleteCol(id) {
        var cell = $j('#measures-table tr.admin td[index=' + id + ']');
        var columnIndex = cell.parent().children().index(cell);
        cols.splice(columnIndex, 1);
        $j('#measures-table thead tr').each(function () {
          var tr = $j(this);
          var td1 = tr.find('th:eq(' + columnIndex + ')');
          td1.detach();
        });
        $j('#measures-table tbody tr').each(function () {
          var tr = $j(this);
          var td1 = tr.find('td:eq(' + columnIndex + ')');
          td1.detach();
        });
      }
    </script>
  <%
     end
     end
  %>

<% if edit_mode %>
  <table class="data width100 admin">
    <tr>
      <td>
        <%= metric_select_tag 'metric', Metric.all.reject { |m| m.data? }, :html_id => 'select-metric', :allow_empty => true -%>
        <button id="add-metric" disabled>Add</button>
      </td>
      <td class="right">
        <a href="#" class="button" id="exit-edit">Done</a>
      </td>
    </tr>
  </table>
  <script>
    $j("#select-metric").on("change", function (e) {
      $j("#add-metric").removeAttr('disabled');
    });
    $j("#add-metric").on("click", function (e) {
      var metric = $j("#select-metric option:selected").val();
      cols.push('metric:' + metric);
      window.location = removeUrlAttr(decodeURI(window.location.href), 'cols\\[\\]') + '&' + $j.map(cols,function (a) {
        return 'cols[]=' + a;
      }).join('&');
    });
    $j("#exit-edit").on("click", function (e) {
      var url = removeUrlAttr(decodeURI(window.location.href), 'cols\\[\\]');
      url = removeUrlAttr(url, 'edit');
      url += '&' + $j.map(cols,function (a) {
        return 'cols[]=' + a;
      }).join('&');
      window.location = url;
    });
  </script>
<% end %>

<table class="data" id="measures-table">
  <thead>
  <tr>
    <% if display_favourites %>
      <th class="thin"></th>
    <% end %>
    <% @filter.display.columns.each do |column| %>
      <%= list_column_html(@filter, column) -%>
    <% end %>
  </tr>
  </thead>
  <tbody>

  <% if edit_mode %>
    <tr class="admin">
      <% if display_favourites %>
        <th></th>
      <% end %>
      <% @filter.display.columns.each_with_index do |column, index| %>
        <td class="<%= column.align -%>" index="<%= index -%>">
          <a href="javascript:leftCol(<%= index -%>)" title="<%= message('move_left') -%>"><%= image_tag("controls/resultset_previous.png") -%></a>
          <a href="javascript:deleteCol(<%= index -%>)" title="<%= message('delete_column') -%>"><%= image_tag("bin_closed.png") -%></a>
          <a href="javascript:rightCol(<%= index -%>)" title="<%= message('move_right') -%>"><%= image_tag("controls/resultset_next.png") -%></a>
        </td>
      <% end %>
  <% end %>

  <% if @filter.base_result %>
    <tr class="highlight">
      <% if display_favourites %>
        <td class="thin"><%= link_to_favourite(@filter.base_result.snapshot.resource) -%></td>
      <% end %>
      <% @filter.display.columns.each do |column| %>
        <td class="<%= column.align -%>">
          <%= list_cell_html(column, @filter.base_result) -%>
        </td>
      <% end %>
    </tr>
  <% end %>

  <% @filter.results.each do |result| %>
    <tr class="<%= cycle 'even', 'odd' -%>">
      <% if display_favourites %>
        <td class="thin"><%= link_to_favourite(result.snapshot.resource) -%></td>
      <% end %>
      <% @filter.display.columns.each do |column| %>
        <td class="<%= column.align -%>">
          <%= list_cell_html(column, result) -%>
        </td>
      <% end %>
    </tr>
  <% end %>

  <% if @filter.results.empty? %>
    <tr class="even">
      <td colspan="<%= colspan -%>"><%= message 'no_data' -%></td>
    </tr>
  <% end %>

  </tbody>
  <%= render :partial => 'utils/tfoot_pagination', :locals => {:pagination => @filter.pagination, :colspan => colspan} %>
</table>