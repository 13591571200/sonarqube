<div class="code-issue"
     data-issue-key="<%= issue.key -%>"
     data-issue-component="<%= issue.componentKey() -%>"
     data-issue-rule="<%= u issue.ruleKey().toString() -%>">

  <div class="code-issue-name">
    <i class="icon-severity-<%= issue.severity.downcase -%>" title="<%= h message("severity.#{issue.severity}") -%>"></i>
    <a href="#" onclick="return toggleIssueRule(this)" class="rulename issue-rule-link"><%= h @issue_results.rule(issue).getName() -%></a>

    <div style="float: right">
      <% unless issue.status == "OPEN" %>
        <i class="icon-status-<%= issue.status.downcase -%>"></i><%= h message("issue.status.#{issue.status}") -%>&nbsp;
      <% end %>
      <% if issue.resolution %>
        <i class="icon-status-<%= issue.resolution.downcase -%>"></i><%= h message("issue.resolution.#{issue.resolution}") -%>&nbsp;
      <% end %>

      <a href="#" onclick="return toggleIssueChangelog(this)" class="gray issue-changelog-link"
         id="toggle-issue-changelog"><%= distance_of_time_in_words_to_now(Api::Utils.java_to_ruby_datetime(issue.updateDate())) -%></a>

      <a href="#" onclick="return openIssuePopup(this)" class="issue-permalink"><img src="<%= ApplicationController.root_context -%>/images/new-window-16.gif"></a>
    </div>
  </div>

  <div class="issue-rule rule-desc" style="display: none"></div>
  <div class="issue-changelog" id="issue-changelog" style="display: none"></div>

  <% unless issue.message.blank? %>
    <div class="code-issue-msg">
      <%= Api::Utils.split_newlines(h(issue.message)).join('<br/>') -%>
    </div>
  <% end %>

  <div class="code-issue-details">
    <ul class="tabs">
      <li>
        <a href="#tab-issue-details"><%= message('issue.details') -%></a>
      </li>
      <li>
        <a href="/dev/issue/rule/<%= u issue.ruleKey().toString() -%>"><%= message('rule') -%></a>
      </li>
      <li>
        <a href="/dev/issue/changelog/<%= issue.key -%>"><%= message('changelog') -%></a>
      </li>
    </ul>
    <div id="tab-issue-details">
      <ul class="code-issue-details-list">
        <li>
          <div class="code-issue-details-term"><%= message('severity') -%></div>
          <div class="code-issue-details-value">
            <i class="icon-severity-<%= issue.severity.downcase -%>"></i><%= h message("severity.#{issue.severity}") -%>
          </div>
        </li>
        <li>
          <div class="code-issue-details-term"><%= message('status') -%></div>
          <div class="code-issue-details-value">
            <i class="icon-status-<%= issue.status.downcase -%>"></i><%= h message("issue.status.#{issue.status}") -%>
          </div>
        </li>
          <li>
            <div class="code-issue-details-term"><%= message('resolution') -%></div>
            <div class="code-issue-details-value">
              <% if issue.resolution %>
                <i class="icon-status-<%= issue.resolution.downcase -%>"></i><%= h message("issue.resolution.#{issue.resolution}") -%>;
              <% else %>
                <%= message('unresolved') -%>
              <% end %>
            </div>
          </li>
        <li>
          <div class="code-issue-details-term"><%= message('issue_filter.header.action_plan') -%></div>
          <div class="code-issue-details-value">
            <% if issue.actionPlanKey %>
              <%= h @issue_results.actionPlan(issue).name() -%>
            <% else %>
              <%= message('none') -%>
            <% end %>
          </div>
        </li>
        <li>
          <div class="code-issue-details-term"><%= message('issue.technical_debt_clear') -%></div>
          <div class="code-issue-details-value">
            <%= h Internal.technical_debt.format(issue.technicalDebt) -%>
          </div>
        </li>
        <% if issue.reporter %>
          <li>
            <div class="code-issue-details-term"><%= message('reporter') -%></div>
            <div class="code-issue-details-value"><%= h @issue_results.user(issue.reporter).name -%></div>
          </li>
        <% end %>
        <li>
          <div class="code-issue-details-term"><%= message('author') -%></div>
          <div class="code-issue-details-value"><%= h issue.authorLogin -%></div>
        </li>
        <li>
          <div class="code-issue-details-term"><%= message('assignee') -%></div>
          <div class="code-issue-details-value">
            <% if issue.assignee %>
              <%= h @issue_results.user(issue.assignee).name -%>
            <% else %>
              <%= message('unassigned') -%>
            <% end %>
          </div>
        </li>
        <li>
          <div class="code-issue-details-term"><%= message('created') -%></div>
          <div class="code-issue-details-value">
            <%= human_short_date(Api::Utils.java_to_ruby_datetime(issue.updateDate)) -%>
          </div>
        </li>
        <li>
          <div class="code-issue-details-term"><%= message('updated') -%></div>
          <div class="code-issue-details-value">
            <%= human_short_date(Api::Utils.java_to_ruby_datetime(issue.creationDate)) -%>
          </div>
        </li>
      </ul>
    </div>
  </div>

  <%
     issue.comments.each do |comment|
       comment_html_id = "comment-#{comment.key}-#{rand(100)}"
  %>
    <div class="code-issue-comment" id="<%= comment_html_id -%>" data-comment-key="<%= comment.key -%>">
      <h4>
        <%= image_tag('reviews/comment.png') -%> &nbsp;<b><%= @issue_results.user(comment.userLogin()).name() -%></b>
        (<%= distance_of_time_in_words_to_now(Api::Utils.java_to_ruby_datetime(comment.createdAt)) -%>)
        <% if current_user && current_user.login==comment.userLogin %>
          &nbsp;
          <%= image_tag 'sep12.png' -%>
          &nbsp;
          <a class="link-action" href="#" onclick="return formEditIssueComment(this)"><%= message('edit') -%></a>
          <a class="link-action spacer-right" href="#" onclick="return deleteIssueComment(this, '<%= escape_javascript(message('issue.comment.delete_confirm_message')) -%>')"><%= message('delete') -%></a>
        <% end %>
      </h4>
      <%= Internal.text.markdownToHtml(comment.markdownText) -%>
    </div>
  <% end %>

  <% if current_user %>

    <div class="code-issue-actions">
      <a href='#' onclick="return issueForm('comment', this)" class="link-action spacer-right" autofocus><%= message('issue.comment.formlink') -%></a>
      <% unless issue.resolution %>
        <img src="<%= ApplicationController.root_context -%>/images/sep12.png"/>
        &nbsp;
        <span class="spacer-right">
        <% if issue.assignee %>
          <a href='#' onclick="return issueForm('assign', this)" class="link-action"><%= message('assigned_to') -%></a> <%= h @issue_results.user(issue.assignee).name -%>
        <% else %>
          <a href='#' onclick="return issueForm('assign', this)" class="link-action"><%= message('issue.assign.formlink') -%></a>
            <% if issue.assignee != current_user.login %>
            [<a href="#" onclick="return assignIssueToMe(this)" class="link-action"><%= message('issue.assign.to_me') -%></a>]
            <% end %>
        <% end %>
        </span>
        <img src="<%= ApplicationController.root_context -%>/images/sep12.png"/>
        &nbsp;
        <span class="spacer-right">
          <% if issue.actionPlanKey %>
            <a href="#" onclick="return issueForm('plan', this)" class="link-action"><%= message('issue.planned_for') -%></a> <%= h(@issue_results.actionPlan(issue).name()) -%>
          <% else %>
            <a href="#" onclick="return issueForm('plan', this)" class="link-action"><%= message('issue.do_plan') -%></a>
          <% end %>
        </span>
      <% end %>

      <%
         transitions = Internal.issues.listTransitions(issue).to_a

         # Display only the first transition
         if !transitions.empty? && transitions.first
           first_transition = transitions.first
      %>
        <img src="<%= ApplicationController.root_context -%>/images/sep12.png"/>
        &nbsp;
        <a href="#" onclick="return doIssueTransition(this, '<%= first_transition.key -%>')" class="link-action spacer-right"><%= message("issue.transition.#{first_transition.key}") -%></a>
      <% end %>

      <%
         plugin_actions = Internal.issues.listActions(issue)
         shouldDisplayDropDown = transitions.size > 1 || !issue.resolution || !plugin_actions.empty?
         if shouldDisplayDropDown
      %>
        <div class="dropdown">
          <a href="#" class="link-action link-more" onclick="showDropdownMenuOnElement($j(this).next('.dropdown-menu')); return false;"><%= message('more_actions') -%></a>
          <ul style="display: none" class="dropdown-menu">
            <% if Java::OrgSonarServerUser::UserSession.get().hasProjectPermission('issueadmin', issue.projectKey) %>
              <% unless issue.resolution %>
                <li>
                  <a href="#" onclick="return issueForm('severity', this)" class="link-action spacer-right"><%= message("issue.set_severity") -%></a>
                </li>
              <% end %>
            <% end %>

            <% # Display remaining transitions
               if transitions.size > 1
                 transitions[1..-1].each do |transition| %>
              <li>
                <a href="#" onclick="return doIssueTransition(this, '<%= transition.key -%>')" class="link-action spacer-right"><%= message("issue.transition.#{transition.key}") -%></a>
              </li>
            <%  end
               end %>

            <% # Display actions defined by plugins
               plugin_actions.each do |action| %>
              <li>
                <a href="#" onclick="return doPluginIssueAction(this, '<%= action.key -%>')" class="link-action spacer-right"><%= message("issue.action.#{action.key}.formlink") -%></a>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>
    <div class="code-issue-form hidden"></div>
  <% elsif issue.assignee || issue.actionPlanKey %>
    <div class="code-issue-actions">
      <% if issue.assignee %>
        <span class="gray"><%= message('assigned_to') -%> <%= h @issue_results.user(issue.assignee).name -%></span>
        &nbsp;
      <% end %>
      <% if issue.actionPlanKey %>
        <% if issue.assignee %><img src="<%= ApplicationController.root_context -%>/images/sep12.png"/>&nbsp;<% end %>
        <span class="gray"><%= message('issue.planned_for') -%> <%= h(@issue_results.actionPlan(issue).name()) -%></span>
      <% end %>
    </div>
  <% end %>
</div>

<script>
  $j(function() {
    $j('.code-issue-details').tabs();
  });
</script>
