<script type="text/javascript">
  function changeMetric() {
    document.location = '<%= ApplicationController.root_context-%>/manual_measures/new/<%= @resource.id -%>?metric=' + $('metricSelect').getValue();
    return false;
  }
  function saveAndAddNew() {
    $('redirect_to_new').setValue('true');
    return true;
  }
</script>
<h1 class="marginbottom10">Add manual measure</h1>
<form action="<%= url_for :action => (@measure ? 'save' : 'new') -%>" method="POST" id="createForm">
  <input type="hidden" name="id" value="<%= @resource.id -%>"/>
  <table class="width100 form">
    <tbody>
    <tr>
      <td class="keyCell">
        Metric:
      </td>
      <td>
        <select name="metric" onchange="changeMetric();" id="metricSelect">
          <%= options_grouped_by_domain(Metric.all.select { |m| m.user_managed? }, (@metric ? @metric.key : nil), :include_empty => true) -%>
        </select>
        <%= link_to 'Manage metrics', :controller => 'metrics', :action => 'index' if has_role?(:admin)-%>

        <% if @metric && @metric.description %>
          <br/>
          <span class="note"><%= @metric.description -%></span>
        <% end %>
      </td>
    </tr>
    <% if @measure %>
      <tr>
        <td class="keyCell">
          Value:
        </td>
        <td>
          <input type="text" name="val" id="valueText" value="<%= @measure.value -%>"/>
        </td>
      </tr>
      <tr>
        <td class="keyCell">
          Description:
        </td>
        <td>
          <textarea rows="5" cols="80" name="desc" class="width100"><%= @measure.description -%></textarea>
        </td>
      </tr>
      <% unless @measure.new_record?() %>
        <tr>
          <td class="keyCell">
            Last change:
          </td>
          <td>
            By <%= @measure.username -%> on <%= l(@measure.updated_at) -%>
          </td>
        </tr>
      <% end %>
    <% end %>
    <tr>
      <td class="keyCell">
      </td>
      <td>
        <% if @measure %>
          <input type="hidden" name="redirect_to_new" value="false" id="redirect_to_new"/>
          <input type="submit" value="Save"/>
          <input type="submit" value="Save & Add new" onclick="saveAndAddNew()"/>
        <% end %>
        <%= link_to 'Cancel', :action => 'index', :id => @resource.id -%>
      </td>
    </tr>
    </tbody>
  </table>
</form>

<% if @metric %>
  <script type="text/javascript">
    $('valueText').focus();
  </script>
<% end %>