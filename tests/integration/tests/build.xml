<project name="Integration tests" basedir=".">
  <property environment="env"/>
  <property name="projects.dir" value="${basedir}/custom-projects"/>

  <target name="prepare-extensions" depends="build-extensions">
    <delete dir="${basedir}/target/extensions"/>
    <mkdir dir="${basedir}/target/extensions"/>
    <copy todir="${basedir}/target/extensions/rules/checkstyle" overwrite="true" verbose="true" flatten="true">
      <fileset dir="${basedir}/../checkstyle-extensions">
        <include name="checkstyle-extensions.xml"/>
        <include name="target/checkstyle-extensions-*.jar"/>
      </fileset>
    </copy>
    <copy todir="${basedir}/target/extensions/rules/pmd" overwrite="true" verbose="true" flatten="true">
      <fileset dir="${basedir}/../pmd-extensions">
        <include name="pmd-extensions.xml"/>
        <include name="target/pmd-extensions-*.jar"/>
      </fileset>
    </copy>
    <copy todir="${basedir}/target/extensions/plugins" flatten="true">
      <fileset dir="${basedir}/target/sonar-basic-sample-plugin/target/">
        <include name="sonar-basic-sample-plugin-*-SNAPSHOT.jar"/>
      </fileset>
      <fileset dir="${basedir}/target/sonar-gwt-sample-plugin/target/">
        <include name="sonar-gwt-sample-plugin-*-SNAPSHOT.jar"/>
      </fileset>
      <fileset dir="${basedir}/../sonar-it-reference-plugin/">
        <include name="target/sonar-it-reference-plugin-*-SNAPSHOT.jar"/>
      </fileset>
    </copy>
  </target>

  <target name="build-extensions">
    <mkdir dir="${basedir}/target"/>

    <mvn dir="target"
         args="archetype:generate -B -DarchetypeGroupId=org.codehaus.sonar.archetypes -DarchetypeArtifactId=sonar-basic-plugin-archetype -DarchetypeVersion=${sonar.runtimeVersion} -DgroupId=com.mycompany.sonar -DartifactId=sonar-basic-sample-plugin -Dversion=0.1-SNAPSHOT"/>
    <mvn args="install" dir="${basedir}/target/sonar-basic-sample-plugin"/>

    <mvn dir="target"
         args="archetype:generate -B -DarchetypeGroupId=org.codehaus.sonar.archetypes -DarchetypeArtifactId=sonar-gwt-plugin-archetype -DarchetypeVersion=${sonar.runtimeVersion} -DgroupId=com.mycompany.sonar -DartifactId=sonar-gwt-sample-plugin -Dversion=0.1-SNAPSHOT"/>

    <mvn args="install" dir="${basedir}/target/sonar-gwt-sample-plugin"/>
  </target>


  <target name="analyze-custom-projects"
          depends="ant-static,ant-dynamic-clover,ant-dynamic-cobertura,ant-dynamic-junit,deprecated-sonar-light,struts,timemachine,violations-timemachine,reuse-coverage-reports"/>

  <target name="ant-static">
    <execant dir="${projects.dir}/ant-static/"/>
    <mvnsonar pom="${projects.dir}/ant-static/pom.xml"/>
  </target>
  <target name="ant-dynamic-clover">
    <execant dir="${projects.dir}/ant-dynamic-clover/"/>
    <mvnsonar pom="${projects.dir}/ant-dynamic-clover/pom.xml"/>
  </target>
  <target name="ant-dynamic-cobertura">
    <execant dir="${projects.dir}/ant-dynamic-cobertura/"/>
    <mvnsonar pom="${projects.dir}/ant-dynamic-cobertura/pom.xml"/>
  </target>
  <target name="ant-dynamic-junit">
    <execant dir="${projects.dir}/ant-dynamic-junit/"/>
    <mvnsonar pom="${projects.dir}/ant-dynamic-junit/pom.xml"/>
  </target>
  <target name="deprecated-sonar-light">
    <execant dir="${projects.dir}/deprecated-sonar-light/"/>
    <mvnsonar pom="${projects.dir}/deprecated-sonar-light/pom.xml"/>
  </target>
  <target name="reuse-coverage-reports">
    <mvn args="clean install" dir="${projects.dir}/reuse-coverage-reports/" failonerror="false"/>
    <mvnsonar pom="${projects.dir}/reuse-coverage-reports/pom.xml"/>
  </target>

  <target name="struts">
    <mvn
        args="scm:checkout -DconnectionUrl=scm:svn:http://svn.apache.org/repos/asf/struts/struts1/tags/STRUTS_1_3_9 -DcheckoutDirectory=struts-1.3.9"
        dir="${projects.dir}"/>
    <mvn args="clean install -DskipTests" dir="${projects.dir}/struts-1.3.9"/>
    <mvnsonar pom="${projects.dir}/struts-1.3.9/pom.xml"/>
  </target>

  <target name="timemachine">
    <mvn args="clean install -DskipTests" dir="${projects.dir}/timemachine"/>

    <!-- last : 1.0-SNAPSHOT -->
    <mvnsonar failonerror="false" pom="${projects.dir}/timemachine/pom.xml"/>

    <!-- past revisions -->
    <mvnsonar failonerror="false"
              args="-Dsonar.projectDate=2007-03-12 -Dsonar.projectVersion=0.5-SNAPSHOT"
              pom="${projects.dir}/timemachine/pom.xml"/>
    <mvnsonar failonerror="false"
              args="-Dsonar.projectDate=2007-04-20 -Dsonar.projectVersion=0.5"
              pom="${projects.dir}/timemachine/pom.xml"/>
    <mvnsonar args="-Dsonar.projectDate=2007-10-20 -Dsonar.projectVersion=0.6"
              pom="${projects.dir}/timemachine/pom.xml"/>
    <mvnsonar args="-Dsonar.projectDate=2007-12-10 -Dsonar.projectVersion=0.7"
              pom="${projects.dir}/timemachine/pom.xml"/>
    <mvnsonar args="-Dsonar.projectDate=2008-02-07 -Dsonar.projectVersion=0.8"
              pom="${projects.dir}/timemachine/pom.xml"/>
    <mvnsonar failonerror="false"
              args="-Dsonar.projectDate=2008-04-15 -Dsonar.projectVersion=0.8"
              pom="${projects.dir}/timemachine/pom.xml"/>
    <mvnsonar failonerror="false"
              args="-Dsonar.projectDate=2008-11-27 -Dsonar.projectVersion=0.9"
              pom="${projects.dir}/timemachine/pom.xml"/>
    <mvnsonar failonerror="false"
              args="-Dsonar.projectDate=2008-10-19 -Dsonar.projectVersion=0.9"
              pom="${projects.dir}/timemachine/pom.xml"/>
  </target>

  <target name="violations-timemachine">
    <mvn args="clean install -DskiptTests" dir="${projects.dir}/violations-timemachine/v1"/>
    <mvnsonar failonerror="false"
              pom="${projects.dir}/violations-timemachine/v1/pom.xml"/>

    <mvn args="clean install -DskiptTests" dir="${projects.dir}/violations-timemachine/v2"/>
    <mvnsonar failonerror="false"
              pom="${projects.dir}/violations-timemachine/v2/pom.xml"/>
  </target>

  <target name="big-project">
    <exec executable="ruby" failonerror="true" dir="${projects.dir}/big-project">
      <arg line="generate-sources.rb 20 50"/>
    </exec>
    <mvn dir="${projects.dir}/big-project" args="clean install -DskipTests"/>
    <mvnsonar pom="${projects.dir}/big-project/pom.xml" args="-Dcpd.skip=true"/>
    <delete dir="${projects.dir}/big-project/src/main/java"/>
  </target>

  <target name="huge-project">
    <exec executable="ruby" failonerror="true" dir="${projects.dir}/big-project">
      <arg line="generate-sources.rb 50 500"/>
    </exec>
    <mvn dir="${projects.dir}/big-project" args="clean install -DskipTests"/>
    <mvnsonar pom="${projects.dir}/big-project/pom.xml" args="-Dcpd.skip=true"/>
    <delete dir="${projects.dir}/big-project/src/main/java"/>
  </target>

  <macrodef name="execant">
    <attribute name="failonerror" default="true"/>
    <attribute name="dir"/>

    <sequential>
      <exec dir="@{dir}" failonerror="@{failonerror}" executable="${env.ANT_HOME}/bin/ant.bat" osfamily="Windows">
      </exec>
      <exec dir="@{dir}" failonerror="@{failonerror}" executable="${env.ANT_HOME}/bin/ant" osfamily="unix">
      </exec>
    </sequential>
  </macrodef>

  <macrodef name="mvn">
    <attribute name="failonerror" default="true"/>
    <attribute name="args" default=""/>
    <attribute name="dir"/>

    <sequential>
      <echo>Executing ${maven.home}/bin/mvn @{args}</echo>
      <exec dir="@{dir}" failonerror="@{failonerror}" executable="${maven.home}/bin/mvn.bat" osfamily="Windows">
        <arg line="@{args} -B -e"/>
      </exec>
      <exec dir="@{dir}" failonerror="@{failonerror}" executable="${maven.home}/bin/mvn" osfamily="unix">
        <arg line="@{args} -B -e"/>
      </exec>
    </sequential>
  </macrodef>

  <macrodef name="mvnsonar">
    <attribute name="failonerror" default="true"/>
    <attribute name="args" default=""/>
    <attribute name="pom"/>

    <sequential>
      <exec failonerror="@{failonerror}" executable="${maven.home}/bin/mvn.bat" osfamily="Windows">
        <arg line="org.codehaus.mojo:sonar-maven-plugin:1.0-beta-2:sonar @{args} -B -e"/>
        <arg line="-f @{pom}"/>
        <arg value='-Dsonar.jdbc.url="${sonar.jdbc.url}"'/>
        <arg value="-Dsonar.jdbc.driver=${sonar.jdbc.driver}"/>
        <arg value="-Dsonar.jdbc.username=${sonar.jdbc.username}"/>
        <arg value="-Dsonar.jdbc.password=${sonar.jdbc.password}"/>
        <arg value="-Dsonar.hardIndexLock=true"/>
      </exec>
      <exec failonerror="@{failonerror}" executable="${maven.home}/bin/mvn" osfamily="unix">
        <arg line="org.codehaus.mojo:sonar-maven-plugin:1.0-beta-2:sonar @{args} -B -e"/>
        <arg line="-f @{pom}"/>
        <arg value='-Dsonar.jdbc.url=${sonar.jdbc.url}'/>
        <arg value="-Dsonar.jdbc.driver=${sonar.jdbc.driver}"/>
        <arg value="-Dsonar.jdbc.username=${sonar.jdbc.username}"/>
        <arg value="-Dsonar.jdbc.password=${sonar.jdbc.password}"/>
        <arg value="-Dsonar.hardIndexLock=true"/>
      </exec>
    </sequential>
  </macrodef>

</project>
