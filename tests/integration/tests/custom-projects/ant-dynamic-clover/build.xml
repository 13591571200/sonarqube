<project name="ant-dynamic-clover" default="all" basedir=".">
  <description>
    money build file
  </description>

  <property name="src" location="src/main/java"/>
  <property name="test.src" location="src/test/java"/>
  <property name="app.build" location="build/app"/>
  <property name="test.build" location="build/test"/>
  <property name="test.result" location="build/testresult"/>
  <property name="junit.jar" location="${basedir}/lib/junit-3.8.2.jar"/>

  <path id="clover.classpath">
    <fileset dir="lib/clover">
      <include name="*.jar"/>
      <include name="clover.license"/>
    </fileset>
  </path>

  <property name="clover.jar" location="${basedir}/lib/clover/clover.jar"/>
  <taskdef resource="cloverlib.xml" classpath="${clover.jar}"/>

  <target name="with.clover">
    <clover-setup/>
  </target>

  <target name="clover.xml" depends="with.clover">
    <mkdir dir="build/reports"/>
    <clover-report>
      <current outfile="build/reports/coverage.xml">
        <format type="xml"/>
      </current>
    </clover-report>
  </target>

  <target name="clover.html" depends="with.clover">
    <mkdir dir="build/reports"/>
    <clover-html-report outdir="build/reports"/>
  </target>

  <path id="build.classpath">
    <pathelement path="${junit.jar}"/>
    <pathelement path="${app.build}"/>
    <path refid="clover.classpath"/>
  </path>

  <path id="testbuild.classpath">
    <path refid="build.classpath"/>
    <pathelement path="${test.build}"/>
  </path>


  <target name="code.compile"
          description="Creates ${app.build} directory and compiles sources from ${src} to ${app.build}">
    <mkdir dir="${app.build}"/>
    <javac srcdir="${src}" destdir="${app.build}" classpathref="build.classpath" source="1.4" fork="true" />
  </target>

  <target name="test.compile" depends="code.compile"
          description="Creates ${test.build} directory and compiles sources from ${test.src} to ${test.build}">
    <mkdir dir="${test.build}"/>
    <javac srcdir="${test.src}"
           destdir="${test.build}"
           classpathref="testbuild.classpath" source="1.4" fork="true"/>
  </target>

  <target name="test.run" depends="with.clover,test.compile" description="Runs the tests">
    <mkdir dir="${test.result}"/>
    <junit printsummary="true" showoutput="true" fork="true" forkmode="once">
      <classpath refid="testbuild.classpath"/>
      <formatter type="xml"/>
      <batchtest fork="yes" todir="${test.result}">
        <fileset dir="${test.src}" includes="**/*Test.java"/>
      </batchtest>
    </junit>
  </target>

  <target name="clean">
    <delete dir="build"/>
  </target>

  <target name="all" depends="clean,test.run,clover.xml,clover.html"/>
</project>
