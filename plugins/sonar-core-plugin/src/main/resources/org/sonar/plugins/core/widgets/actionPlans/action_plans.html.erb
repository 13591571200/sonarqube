<%
   if has_role?(:user, @project)
     action_plans = ActionPlan.find(:all, :conditions => ['status= ? AND project_id=?', ActionPlan::STATUS_OPEN, @project.id], 
                                          :include => 'reviews', :order => 'dead_line ASC')
     
     div_id = "action-plan-widget-#{widget.id.to_s}"
%>

<div class="line-block">
  <div style="float:right">
    <a href="<%= url_for :controller => 'action_plans', :action => 'index', :id => @project.id -%>">
      <%= message('widgets.more') -%>
    </a>
  </div>
  <h3><%= message('widget.action_plans.title') -%></h3>
</div>

<% if action_plans.size ==0 %>
  <span class="empty_widget"><%= message('widget.action_plans.no_action_plan') -%></span>
<% else %>

<div id="<%= div_id -%>">
  <table class="width100 data actionPlans">
    <thead>
    <tr>
      <th colspan="3"></th>
    </tr>
    </thead>
    <tbody>
      <%
         action_plans.each do |plan|
      %>
      <tr class="<%= cycle 'even', 'odd', :name => (div_id) -%>">
        <td class="thin nowrap"><%= h(plan.name) -%></td>
        <td class="thin nowrap <%= 'over-due' if plan.over_due? -%>" align="right" x="<%= plan.dead_line ? plan.dead_line.tv_sec : '' -%>"><%= plan.dead_line ? plan.dead_line.strftime("%d %b %Y") : ' '  -%></td>
        <% if plan.progress[:total]==0 %>
        <td class="noprogress thin nowrap"><%= message('action_plans.no_reviews_linked_to_action_plan') -%></td>
        <% else %>
        <td class="progress thin">
            <%= render :partial => 'action_plans/progress', :locals => {:action_plan => plan} -%>
        </td>
        <% end %>
      </tr>
      <% 
         end 
      %>
    </tbody>
  </table>
</div>

<% end %>

<% end %>
